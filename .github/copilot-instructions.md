# GitHub Copilot Instructions for Terraform Module Projects

This document provides guidance for GitHub Copilot when working with Terraform modules that follow the company's standard structure. The structure documented here is based on HashiCorp's recommended practices for modules that will be published to the Terraform Registry.

## Standard Terraform Module Structure

Note: This structure is a guideline and may vary based on the specific needs of the module. The goal is to maintain consistency across all modules within the organization.

A compliant Terraform module should adhere to the following file and directory structure:

### Root Directory

- `main.tf` - Main module resources and implementation
- `variables.tf` - Input variable declarations
- `outputs.tf` - Output value declarations
- `versions.tf` - Terraform and provider version constraints
- `README.md` - Module documentation with generated content
- `CHANGELOG.md` - Version history using conventional commits
- `LICENSE.md` - License information
- `renovate.json` - Configuration for Renovate bot dependency updates

### Documentation

- `docs/` - Additional documentation
  - `Development.md` - Guidelines for module development

### Examples

Note: the number of examples may vary based on the complexity of the module. Each example should be self-contained and demonstrate different use cases.

- `examples/` - Example implementations of the module
  - `01-basic/` - Minimal example with default values
    - `main.tf` - Basic implementation
    - `variables.tf` - Example-specific variables
    - `outputs.tf` - Example outputs
    - `README.md` - Example documentation
  - `02-full/` - More complex example with all features
    - `main.tf` - Advanced implementation
    - `variables.tf` - Example-specific variables
    - `outputs.tf` - Example outputs
    - `README.md` - Example documentation

### Tests

- `tests/` - Test configurations
  - `common-test.auto.tfvars` - Common test variables, values in this file are automatically loaded by the test framework. Ie. they serve as default values for the tests. Values can be overridden for each test as needed.
  - `unit-tests.tftest.hcl` - Unit tests for module validation
  - `integration-test-01-basic.tftest.hcl` - Tests for basic example
  - `integration-test-02-full.tftest.hcl` - Tests for full example

### Configuration

- `.terraform-docs.yml` - Configuration for terraform-docs
- `.tflint.hcl` - Configuration for TFLint
- `.github/workflows/` - CI/CD workflows
  - `test.yaml` - Testing workflow
  - `tag-and-release.yaml` - Release process workflow
- `.github/copilot/` - GitHub Copilot configuration
  - `instructions.md` - Instructions for GitHub Copilot (this file)

## Best Practices for Terraform Module Development

### File Responsibilities

- **main.tf**: Contains the primary resources created by the module, local variables, and data sources
- **variables.tf**: Defines all input variables with descriptions, types, defaults, and validations
- **outputs.tf**: Defines all outputs with descriptions
- **versions.tf**: Specifies required Terraform version and provider versions

Note: avoid making `main.tf` too large to be comprehensible. Break it into smaller files if necessary. When breaking it up, use a consistent naming convention like `main.nsgs.tf`, `main.vnet.tf`, etc. This also applies to `variables.tf` and `outputs.tf`.

### Code Standards

1. Use consistent naming conventions:
   - Resources should have descriptive names and not be pluralized
   - Use lowercase letters and hyphens for resource names, variable names and outputs
   - Variable names should be clear and follow a pattern
   - Outputs should represent the key information needed by module consumers
   - Output primitive data types when possible (e.g., string, number, bool), not entire resource objects

2. Documentation:
   - Always include detailed descriptions for variables and outputs, use multiline heredoc syntax for long descriptions
   - README.md file in the root directory should provide an overview of the module. Documentation between `<!-- BEGIN_TF_DOCS -->` and `<!-- END_TF_DOCS -->` should be auto-generated by terraform-docs
   - README.md files in the examples directory should provide context for the example, including Purpose of the example. Documentation between `<!-- BEGIN_TF_DOCS -->` and `<!-- END_TF_DOCS -->` should be auto-generated by terraform-docs
   - Document examples thoroughly

3. Testing:
   - Include unit tests for variable validations
   - Include integration tests for examples

## Variable Validation Patterns

The modules should implement comprehensive validation for variables:

1. Presence validation:

   Part of the validation will be handled by terraform using the variable definition, e.g.: `nullable` or `default`. Things terraform does not handle, we will do it in the validation block.

   ```hcl
   validation {
     error_message = "The 'variable_name' cannot be empty string."
     condition     = length(var.variable_name) > 0
   }
   ```

2. Allowed value validation:

   ```hcl
   validation {
     error_message = "The 'variable_name' must be one of [value1, value2]."
     condition     = contains(["value1", "value2"], var.variable_name)
   }
   ```

3. Complex validation:

   ```hcl
   validation {
     error_message = "Complex validation error message."
     condition     = can(regex("pattern", var.variable_name))
   }
   ```

## Terraform Testing Patterns

The module should include both unit tests and integration tests:

1. Unit tests (`unit-tests.tftest.hcl`):
   - Test variable validations
   - Test resource attributes
   - Test naming conventions
   - Should use mock providers when testing outputs to avoid real resource creation, since output tests require `command = apply`
   - Should cover all possible input variable values, both negative and positive tests.
   - Should cover all available outputs, both positive and negative tests.

2. Integration tests:
   - Should use real resources but can be run in a separate environment
   - Usually, examples are used for integration tests, e.g.:
     - Basic example tests (`integration-test-01-basic.tftest.hcl`)
     - Full example tests (`integration-test-02-full.tftest.hcl`)

## Code Linting

The module uses TFLint for code quality verification. The configuration is in `.tflint.hcl` and includes:

- Terraform language rules
- Provider-specific rules
- Formatting rules

## Example Usage Pattern

These should always be included, but more examples can be added as needed. The examples should be self-contained and demonstrate different use cases of the module.

1. Basic example:
   - Uses minimal required variables
   - Uses default values for most parameters

2. Full example:
   - Demonstrates all features
   - Overrides default values
   - Shows complex configurations
